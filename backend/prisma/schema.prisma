// Sistema de Nómina - Esquema de Base de Datos
// Compatible con normativas mexicanas (IMSS, ISSSTE, SAT, INFONAVIT)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MÓDULO: CONFIGURACIÓN DEL SISTEMA
// ============================================

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  dataType    String   @default("string") @map("data_type") // string, boolean, number, json
  category    String   @default("general")
  isPublic    Boolean  @default(false) @map("is_public") // Si es visible para todos los usuarios
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ============================================
// MÓDULO: AUTENTICACIÓN Y USUARIOS
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  isActive     Boolean  @default(true) @map("is_active")
  roleId       String   @map("role_id")
  role         Role     @relation(fields: [roleId], references: [id])
  companyId    String?  @map("company_id")
  company      Company? @relation(fields: [companyId], references: [id])
  // Autenticación externa (Microsoft, Google, etc.)
  authProvider String?  @map("auth_provider") // local, microsoft, google
  externalId   String?  @map("external_id") // ID del proveedor externo
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  auditLogs         AuditLog[]
  benefitsCreated   Benefit[] @relation("BenefitCreator")
  benefitsApproved  Benefit[] @relation("BenefitApprover")
  notifications     Notification[]
  // P0.2 - Segregación de Funciones: Dual Control
  dualControlRequestsMade     DualControlRequest[] @relation("DualControlRequester")
  dualControlRequestsApproved DualControlRequest[] @relation("DualControlApprover")
  // P0.1 - MFA
  mfaConfig                   MfaConfig?

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json     @default("[]")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  oldValues Json?    @map("old_values")
  newValues Json?    @map("new_values")
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  // P0.3 - Auditoría Tamper-Evident: Hash encadenado
  entryHash        String?  @map("entry_hash")        // SHA-256 del contenido de esta entrada
  previousEntryHash String? @map("previous_entry_hash") // Hash de la entrada anterior (cadena)
  sequenceNumber   Int?     @map("sequence_number")   // Número de secuencia para verificación

  // MEJORA GOB: Campos de justificación y doble control
  justification       String?   @db.Text // Motivo obligatorio para acciones críticas
  requiresConfirmation Boolean  @default(false) @map("requires_confirmation")
  confirmedAt         DateTime? @map("confirmed_at")
  confirmedBy         String?   @map("confirmed_by")
  isCriticalAction    Boolean   @default(false) @map("is_critical_action")
  legalBasis          String?   @map("legal_basis") @db.Text

  @@index([isCriticalAction])
  @@index([entryHash])
  @@index([sequenceNumber])
  @@map("audit_logs")
}

// P0.2 - Segregación de Funciones: Dual Control (Maker-Checker)
model DualControlRequest {
  id               String   @id @default(uuid())
  requesterId      String   @map("requester_id")
  requester        User     @relation("DualControlRequester", fields: [requesterId], references: [id])
  operation        String   // PAYROLL_APPROVE, CFDI_CANCEL, SALARY_CHANGE, etc.
  entity           String   // PayrollPeriod, CfdiNomina, Employee, etc.
  entityId         String   @map("entity_id")
  details          Json     @default("{}")
  justification    String   @db.Text
  status           String   @default("PENDING") // PENDING, APPROVED, REJECTED, EXPIRED, CANCELLED
  approverId       String?  @map("approver_id")
  approver         User?    @relation("DualControlApprover", fields: [approverId], references: [id])
  approverComments String?  @map("approver_comments") @db.Text
  expiresAt        DateTime @map("expires_at")
  approvedAt       DateTime? @map("approved_at")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([requesterId])
  @@index([approverId])
  @@index([status])
  @@index([operation])
  @@index([entity, entityId])
  @@index([expiresAt])
  @@map("dual_control_requests")
}

model Notification {
  id        String   @id @default(uuid())
  type      String   // CFDI_STAMPED, PAYROLL_COMPLETED, etc.
  title     String
  message   String
  metadata  Json     @default("{}")
  priority  Int      @default(2) // 1=high, 2=normal, 3=low
  isRead    Boolean  @default(false) @map("is_read")
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  @@index([userId, isRead])
  @@index([companyId])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// MÓDULO: EMPRESA Y DEPARTAMENTOS
// ============================================

model Company {
  id                String   @id @default(uuid())
  name              String
  rfc               String   @unique

  // Tipo de institucion
  institutionType   InstitutionType @default(PRIVATE) @map("institution_type")
  govInstitution    GovInstitution? @map("gov_institution") // Solo si es GOVERNMENT

  // Registro patronal IMSS (principal)
  registroPatronal  String?  @map("registro_patronal")

  // Otros registros (opcionales)
  registroPatronalIssste String? @map("registro_patronal_issste")

  // Direccion
  address           String?
  city              String?
  state             String?
  zipCode           String?  @map("zip_code")
  phone             String?
  email             String?

  // Branding y personalización
  logo              String?  // URL o base64 del logo
  primaryColor      String?  @default("#1E40AF") @map("primary_color")
  secondaryColor    String?  @default("#3B82F6") @map("secondary_color")

  // Configuración CFDI
  regimenFiscal     String?  @map("regimen_fiscal") // Código SAT (601, 605, etc.)
  certificadoCer    String?  @map("certificado_cer") @db.Text // Certificado .cer en base64
  certificadoKey    String?  @map("certificado_key") @db.Text // Llave privada .key en base64
  certificadoPassword String? @map("certificado_password") // Contraseña del certificado
  noCertificado     String?  @map("no_certificado") // Número de certificado SAT
  certificadoVigenciaInicio DateTime? @map("certificado_vigencia_inicio")
  certificadoVigenciaFin DateTime? @map("certificado_vigencia_fin")

  // Configuración PAC (Proveedor Autorizado de Certificación)
  pacProvider       String?  @map("pac_provider") // Nombre del PAC (FINKOK, SW, etc.)
  pacUser           String?  @map("pac_user")
  pacPassword       String?  @map("pac_password")
  pacMode           String?  @default("sandbox") @map("pac_mode") // sandbox | production

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  departments  Department[]
  employees    Employee[]
  payrollPeriods PayrollPeriod[]
  users        User[]

  // Configuración contable
  payrollConfig CompanyPayrollConfig?
  payrollConcepts CompanyPayrollConcept[]

  // Configuración de nóminas especiales
  specialPayrollConfig CompanySpecialPayrollConfig?
  specialPayrollHistory SpecialPayrollHistory[]
  calculationFormulas CompanyCalculationFormula[]

  // Dispositivos biométricos
  biometricDevices BiometricDevice[]

  // Notificaciones
  notifications    Notification[]

  // Mapeo de conceptos de incidencias
  incidentConceptMappings IncidentConceptMapping[]

  // Configuraciones de PAC
  pacConfigs CompanyPacConfig[]

  @@map("companies")
}

model Department {
  id          String   @id @default(uuid())
  name        String
  description String?
  companyId   String   @map("company_id")
  company     Company  @relation(fields: [companyId], references: [id])
  managerId   String?  @map("manager_id")
  manager     Employee? @relation("DepartmentManager", fields: [managerId], references: [id])
  parentId    String?  @map("parent_id")
  parent      Department? @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  employees Employee[] @relation("EmployeeDepartment")

  @@map("departments")
}

// ============================================
// MÓDULO: EMPLEADOS
// ============================================

model Employee {
  id                  String   @id @default(uuid())
  employeeNumber      String   @unique @map("employee_number")
  firstName           String   @map("first_name")
  middleName          String?  @map("middle_name")
  lastName            String   @map("last_name")
  secondLastName      String?  @map("second_last_name")
  email               String?
  phone               String?
  photoUrl            String?  @map("photo_url") // URL de la foto de perfil
  birthDate           DateTime @map("birth_date")
  gender              Gender
  maritalStatus       MaritalStatus @map("marital_status")

  // Identificación fiscal y gobierno
  rfc                 String   @unique
  curp                String   @unique
  nss                 String?  // Número de Seguro Social (IMSS)
  isssteNumber        String?  @map("issste_number")
  infonavitNumber     String?  @map("infonavit_number")

  // Dirección
  address             String?
  colony              String?  // Colonia
  city                String?
  state               String?
  zipCode             String?  @map("zip_code")

  // Información laboral
  hireDate            DateTime @map("hire_date")
  terminationDate     DateTime? @map("termination_date")
  contractType        ContractType @map("contract_type")
  employmentType      EmploymentType @map("employment_type")
  jobPositionId       String   @map("job_position_id")
  jobPosition         JobPosition @relation(fields: [jobPositionId], references: [id])
  departmentId        String   @map("department_id")
  department          Department @relation("EmployeeDepartment", fields: [departmentId], references: [id])
  companyId           String   @map("company_id")
  company             Company  @relation(fields: [companyId], references: [id])
  workScheduleId      String?  @map("work_schedule_id")
  workSchedule        WorkSchedule? @relation(fields: [workScheduleId], references: [id])

  // Información de pago
  baseSalary          Decimal  @map("base_salary") @db.Decimal(12, 2)
  salaryType          SalaryType @map("salary_type")
  paymentMethod       PaymentMethod @map("payment_method")
  bankId              String?  @map("bank_id")
  bank                Bank?    @relation(fields: [bankId], references: [id])
  bankAccount         String?  @map("bank_account")
  clabe               String?  // CLABE interbancaria

  // IMSS
  salarioDiarioIntegrado Decimal? @map("salario_diario_integrado") @db.Decimal(12, 2)
  tipoSalarioImss     TipoSalarioIMSS? @map("tipo_salario_imss")

  // Estado
  status              EmployeeStatus @default(ACTIVE)
  isActive            Boolean  @default(true) @map("is_active")

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Jerarquía organizacional
  supervisorId        String?  @map("supervisor_id")
  supervisor          Employee? @relation("EmployeeHierarchy", fields: [supervisorId], references: [id])
  subordinates        Employee[] @relation("EmployeeHierarchy")
  hierarchyLevel      Int      @default(0) @map("hierarchy_level") // 0 = sin supervisor, 1+ = niveles

  // Relaciones
  managedDepartments  Department[] @relation("DepartmentManager")
  attendanceRecords   AttendanceRecord[]
  vacationRequests    VacationRequest[]
  payrollDetails      PayrollDetail[]
  benefits            EmployeeBenefit[]
  infonavitCredits    InfonavitCredit[]
  pensionAlimenticia  PensionAlimenticia[]
  salaryHistory       SalaryHistory[]
  cfdiNominas         CfdiNomina[]
  biometricLogs       BiometricLog[]
  emergencyContacts   EmergencyContact[]
  documents           EmployeeDocument[]
  incidents           EmployeeIncident[]
  liquidations        LiquidationCalculation[]

  // Delegaciones de aprobación
  delegationsGiven    ApprovalDelegation[] @relation("DelegationFrom")
  delegationsReceived ApprovalDelegation[] @relation("DelegationTo")

  // Vacaciones - aprobaciones
  supervisorApprovedRequests VacationRequest[] @relation("RequestSupervisorApprover")
  approvedRequests           VacationRequest[] @relation("RequestApprover")
  rejectedRequests           VacationRequest[] @relation("RequestRejecter")

  @@map("employees")
}

model JobPosition {
  id          String   @id @default(uuid())
  name        String
  description String?
  minSalary   Decimal? @map("min_salary") @db.Decimal(12, 2)
  maxSalary   Decimal? @map("max_salary") @db.Decimal(12, 2)
  riskLevel   RiskLevel @default(CLASE_I) @map("risk_level") // Para prima de riesgo IMSS
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  employees Employee[]

  @@map("job_positions")
}

model EmergencyContact {
  id           String   @id @default(uuid())
  employeeId   String   @map("employee_id")
  employee     Employee @relation(fields: [employeeId], references: [id])
  name         String
  relationship String
  phone        String
  email        String?
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("emergency_contacts")
}

model EmployeeDocument {
  id          String   @id @default(uuid())
  employeeId  String   @map("employee_id")
  employee    Employee @relation(fields: [employeeId], references: [id])
  type        DocumentType
  name        String
  path        String
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("employee_documents")
}

model SalaryHistory {
  id          String   @id @default(uuid())
  employeeId  String   @map("employee_id")
  employee    Employee @relation(fields: [employeeId], references: [id])
  oldSalary   Decimal  @map("old_salary") @db.Decimal(12, 2)
  newSalary   Decimal  @map("new_salary") @db.Decimal(12, 2)
  reason      String?
  effectiveDate DateTime @map("effective_date")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("salary_history")
}

// ============================================
// MÓDULO: INCIDENCIAS
// ============================================

model IncidentType {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  category    IncidentCategory
  affectsPayroll Boolean @default(true) @map("affects_payroll")
  isDeduction Boolean  @default(false) @map("is_deduction") // True = descuento, False = percepcion o neutro
  defaultValue Decimal? @map("default_value") @db.Decimal(12, 2)
  valueType   IncidentValueType @default(DAYS) @map("value_type")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  incidents   EmployeeIncident[]
  conceptMappings IncidentConceptMapping[]

  @@map("incident_types")
}

model EmployeeIncident {
  id              String   @id @default(uuid())
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])
  incidentTypeId  String   @map("incident_type_id")
  incidentType    IncidentType @relation(fields: [incidentTypeId], references: [id])
  date            DateTime @db.Date
  value           Decimal  @db.Decimal(10, 2) // Cantidad (dias, horas, monto)
  description     String?
  documentPath    String?  @map("document_path") // Documento de soporte
  status          IncidentStatus @default(PENDING)
  approvedById    String?  @map("approved_by_id")
  approvedAt      DateTime? @map("approved_at")
  payrollPeriodId String?  @map("payroll_period_id") // Periodo en que se aplico
  payrollPeriod   PayrollPeriod? @relation(fields: [payrollPeriodId], references: [id])
  appliedAt       DateTime? @map("applied_at") // Fecha en que se aplico a nomina
  isRetroactive   Boolean  @default(false) @map("is_retroactive") // Si es ajuste de período anterior
  retroactiveNote String?  @map("retroactive_note") // Nota explicativa para ajustes retroactivos
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("employee_incidents")
}

// ============================================
// MÓDULO: ASISTENCIA
// ============================================

model WorkSchedule {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  scheduleDetails WorkScheduleDetail[]
  employees       Employee[]

  @@map("work_schedules")
}

model WorkScheduleDetail {
  id             String   @id @default(uuid())
  workScheduleId String   @map("work_schedule_id")
  workSchedule   WorkSchedule @relation(fields: [workScheduleId], references: [id])
  dayOfWeek      Int      @map("day_of_week") // 0-6 (Domingo-Sábado)
  startTime      String   @map("start_time") // HH:mm
  endTime        String   @map("end_time")   // HH:mm
  breakStart     String?  @map("break_start")
  breakEnd       String?  @map("break_end")
  isWorkDay      Boolean  @default(true) @map("is_work_day")

  @@map("work_schedule_details")
}

model AttendanceRecord {
  id          String   @id @default(uuid())
  employeeId  String   @map("employee_id")
  employee    Employee @relation(fields: [employeeId], references: [id])
  date        DateTime @db.Date
  checkIn     DateTime? @map("check_in")
  checkOut    DateTime? @map("check_out")
  breakStart  DateTime? @map("break_start")
  breakEnd    DateTime? @map("break_end")
  status      AttendanceStatus @default(PRESENT)
  hoursWorked Decimal? @map("hours_worked") @db.Decimal(5, 2)
  overtime    Decimal? @db.Decimal(5, 2)
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, date])
  @@map("attendance_records")
}

model Holiday {
  id          String   @id @default(uuid())
  name        String
  date        DateTime @db.Date
  isNational  Boolean  @default(true) @map("is_national")
  isPaid      Boolean  @default(true) @map("is_paid")
  year        Int
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([date, year])
  @@map("holidays")
}

// ============================================
// MÓDULO: DISPOSITIVOS BIOMÉTRICOS
// ============================================

model BiometricDevice {
  id             String   @id @default(uuid())
  companyId      String   @map("company_id")
  company        Company  @relation(fields: [companyId], references: [id])
  name           String
  deviceType     String   @map("device_type")
  connectionMode String   @default("PULL") @map("connection_mode")
  ip             String?
  port           Int      @default(4370)
  serialNumber   String?  @map("serial_number")
  location       String?
  config         Json?
  status         String   @default("OFFLINE")
  isActive       Boolean  @default(true) @map("is_active")
  lastSyncAt     DateTime? @map("last_sync_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  logs           BiometricLog[]

  @@map("biometric_devices")
}

model BiometricLog {
  id          String   @id @default(uuid())
  deviceId    String   @map("device_id")
  device      BiometricDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  employeeId  String   @map("employee_id")
  employee    Employee @relation(fields: [employeeId], references: [id])
  timestamp   DateTime
  eventType   String   @map("event_type")
  verifyMode  String?  @map("verify_mode")
  rawData     Json?    @map("raw_data")
  processed   Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("biometric_logs")
}

// ============================================
// MÓDULO: VACACIONES Y PERMISOS
// ============================================

model VacationRequest {
  id            String   @id @default(uuid())
  employeeId    String   @map("employee_id")
  employee      Employee @relation(fields: [employeeId], references: [id])
  type          LeaveType
  startDate     DateTime @map("start_date") @db.Date
  endDate       DateTime @map("end_date") @db.Date
  totalDays     Int      @map("total_days")
  reason        String?
  documentPath  String?  @map("document_path") // Documento de soporte (incapacidad IMSS, acta defuncion, etc)
  isPaid        Boolean  @default(true) @map("is_paid") // Si es con goce de sueldo
  status        RequestStatus @default(PENDING)

  // Paso 1: Aprobación del supervisor directo
  supervisorApprovedById  String?   @map("supervisor_approved_by_id")
  supervisorApprovedBy    Employee? @relation("RequestSupervisorApprover", fields: [supervisorApprovedById], references: [id])
  supervisorApprovedAt    DateTime? @map("supervisor_approved_at")
  supervisorComments      String?   @map("supervisor_comments")

  // Paso 2: Validación de RH (aprobación final)
  approvedById  String?  @map("approved_by_id")
  approvedBy    Employee? @relation("RequestApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime? @map("approved_at")
  rhComments    String?  @map("rh_comments")

  // Rechazo (puede ser por supervisor o RH)
  rejectedById   String?  @map("rejected_by_id")
  rejectedBy     Employee? @relation("RequestRejecter", fields: [rejectedById], references: [id])
  rejectedAt     DateTime? @map("rejected_at")
  rejectedReason String?  @map("rejected_reason")
  rejectedStage  String?  @map("rejected_stage") // 'SUPERVISOR' o 'RH'

  // Tracking de la cadena de aprobación
  approvalChain Json?    @map("approval_chain") // [{level: 1, employeeId: "...", name: "...", role: "SUPERVISOR"|"RH", status: "..."}]

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("vacation_requests")
}

// Delegación de aprobaciones
model ApprovalDelegation {
  id              String   @id @default(uuid())

  // Quien delega
  delegatorId     String   @map("delegator_id")
  delegator       Employee @relation("DelegationFrom", fields: [delegatorId], references: [id])

  // A quien delega
  delegateeId     String   @map("delegatee_id")
  delegatee       Employee @relation("DelegationTo", fields: [delegateeId], references: [id])

  // Tipo de aprobación que se delega
  delegationType  DelegationType @map("delegation_type")

  // Vigencia de la delegación
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  reason          String?  // Motivo de la delegación (vacaciones, viaje, etc)

  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("approval_delegations")
}

enum DelegationType {
  VACATION        // Aprobación de vacaciones
  PERMISSION      // Aprobación de permisos
  INCIDENT        // Aprobación de incidencias
  ALL             // Todos los tipos de aprobación
}

// Configuracion de dias de permiso por tipo de ausencia
model LeaveTypeConfig {
  id            String   @id @default(uuid())
  type          LeaveType @unique
  name          String
  description   String?
  maxDays       Int      @map("max_days") // Dias maximos permitidos
  isPaid        Boolean  @default(true) @map("is_paid")
  requiresDocument Boolean @default(false) @map("requires_document")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("leave_type_configs")
}

model VacationBalance {
  id              String   @id @default(uuid())
  employeeId      String   @map("employee_id")
  year            Int
  earnedDays      Int      @map("earned_days") // Días correspondientes por antigüedad
  usedDays        Int      @default(0) @map("used_days")
  pendingDays     Int      @default(0) @map("pending_days")
  expiredDays     Int      @default(0) @map("expired_days")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, year])
  @@map("vacation_balances")
}

// ============================================
// MÓDULO: NÓMINA
// ============================================

model PayrollPeriod {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  company         Company  @relation(fields: [companyId], references: [id])
  periodType      PeriodType @map("period_type")
  extraordinaryType ExtraordinaryType? @map("extraordinary_type") // Solo para periodos extraordinarios
  periodNumber    Int      @map("period_number")
  year            Int
  description     String?  // Descripcion del periodo (util para extraordinarios)
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime @map("end_date") @db.Date
  paymentDate     DateTime @map("payment_date") @db.Date
  incidentDeadline DateTime? @map("incident_deadline") @db.Date // Fecha límite para cargar incidencias
  status          PayrollStatus @default(DRAFT)
  totalPerceptions Decimal @default(0) @map("total_perceptions") @db.Decimal(14, 2)
  totalDeductions  Decimal @default(0) @map("total_deductions") @db.Decimal(14, 2)
  totalNet         Decimal @default(0) @map("total_net") @db.Decimal(14, 2)
  processedAt     DateTime? @map("processed_at")
  closedAt        DateTime? @map("closed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  payrollDetails PayrollDetail[]
  appliedIncidents EmployeeIncident[] // Incidencias aplicadas en este período

  // Autorización de timbrado
  authorizedForStamping Boolean   @default(false) @map("authorized_for_stamping")
  authorizedAt          DateTime? @map("authorized_at")
  authorizedBy          String?   @map("authorized_by")
  stampingAuthorizations StampingAuthorization[]

  @@unique([companyId, periodType, periodNumber, year])
  @@map("payroll_periods")
}

model PayrollDetail {
  id              String   @id @default(uuid())
  payrollPeriodId String   @map("payroll_period_id")
  payrollPeriod   PayrollPeriod @relation(fields: [payrollPeriodId], references: [id])
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])

  // Días trabajados
  workedDays      Decimal  @map("worked_days") @db.Decimal(5, 2)

  // Totales
  totalPerceptions Decimal @map("total_perceptions") @db.Decimal(12, 2)
  totalDeductions  Decimal @map("total_deductions") @db.Decimal(12, 2)
  netPay           Decimal @map("net_pay") @db.Decimal(12, 2)

  // Estado
  status          PayrollDetailStatus @default(PENDING)
  paidAt          DateTime? @map("paid_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  perceptions     PayrollPerception[]
  deductions      PayrollDeduction[]
  cfdiNomina      CfdiNomina?
  calculationAudits PayrollCalculationAudit[]
  fiscalAudits    FiscalCalculationAudit[] // MEJORA: Auditoría fiscal por concepto
  versions        PayrollDetailVersion[] // Historial de versiones para auditoría
  rulesetSnapshots ReceiptRulesetSnapshot[] // Snapshots de reglas usadas
  documents       ReceiptDocument[] // Evidencias fiscales (XML, PDF)

  @@unique([payrollPeriodId, employeeId])
  @@map("payroll_details")
}

model PayrollPerception {
  id               String   @id @default(uuid())
  payrollDetailId  String   @map("payroll_detail_id")
  payrollDetail    PayrollDetail @relation(fields: [payrollDetailId], references: [id])
  conceptId        String   @map("concept_id")
  concept          PayrollConcept @relation(fields: [conceptId], references: [id])
  amount           Decimal  @db.Decimal(12, 2)
  taxableAmount    Decimal  @map("taxable_amount") @db.Decimal(12, 2)
  exemptAmount     Decimal  @map("exempt_amount") @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  // MEJORA: Referencia a fórmula usada para auditoría
  formulaId        String?  @map("formula_id")
  formula          CompanyCalculationFormula? @relation(fields: [formulaId], references: [id])
  formulaVersion   Int?     @map("formula_version")

  @@map("payroll_perceptions")
}

model PayrollDeduction {
  id               String   @id @default(uuid())
  payrollDetailId  String   @map("payroll_detail_id")
  payrollDetail    PayrollDetail @relation(fields: [payrollDetailId], references: [id])
  conceptId        String   @map("concept_id")
  concept          PayrollConcept @relation(fields: [conceptId], references: [id])
  amount           Decimal  @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  // MEJORA: Referencia a fórmula usada para auditoría
  formulaId        String?  @map("formula_id")
  formula          CompanyCalculationFormula? @relation(fields: [formulaId], references: [id])
  formulaVersion   Int?     @map("formula_version")

  @@map("payroll_deductions")
}

model PayrollConcept {
  id              String   @id @default(uuid())
  code            String   @unique
  name            String
  type            ConceptType
  satCode         String?  @map("sat_code") // Código SAT para CFDI
  isTaxable       Boolean  @default(false) @map("is_taxable")
  isFixed         Boolean  @default(false) @map("is_fixed")
  defaultAmount   Decimal? @map("default_amount") @db.Decimal(12, 2)
  formula         String?  // Fórmula de cálculo
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  perceptions     PayrollPerception[]
  deductions      PayrollDeduction[]
  companyConfigs  CompanyPayrollConcept[]
  incidentMappings IncidentConceptMapping[]

  @@map("payroll_concepts")
}

// ============================================
// MÓDULO: IMPUESTOS Y CÁLCULOS SAT
// ============================================
// Note: IsrTable and SubsidioEmpleoTable are defined in the accounting section below

// ============================================
// MÓDULO: IMSS / ISSSTE / INFONAVIT
// ============================================

model ImssRate {
  id                  String   @id @default(uuid())
  year                Int
  concept             String   // EYM, IV, RT, Guardería, etc.
  employerRate        Decimal  @map("employer_rate") @db.Decimal(6, 4)
  employeeRate        Decimal  @map("employee_rate") @db.Decimal(6, 4)
  salaryBase          SalaryBaseType @map("salary_base") // SBC, SMG, etc.
  createdAt           DateTime @default(now()) @map("created_at")

  @@unique([year, concept])
  @@map("imss_rates")
}

model InfonavitCredit {
  id              String   @id @default(uuid())
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])
  creditNumber    String   @map("credit_number")
  discountType    InfonavitDiscountType @map("discount_type")
  discountValue   Decimal  @map("discount_value") @db.Decimal(12, 2)
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("infonavit_credits")
}

model PensionAlimenticia {
  id              String   @id @default(uuid())
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])
  beneficiaryName String   @map("beneficiary_name")
  discountType    PensionDiscountType @map("discount_type")
  discountValue   Decimal  @map("discount_value") @db.Decimal(12, 2)
  courtOrder      String?  @map("court_order")
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("pension_alimenticia")
}

// ============================================
// MÓDULO: TIMBRADO CFDI
// ============================================

model CfdiNomina {
  id              String   @id @default(uuid())
  payrollDetailId String   @unique @map("payroll_detail_id")
  payrollDetail   PayrollDetail @relation(fields: [payrollDetailId], references: [id])
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])

  // Datos del CFDI
  uuid            String?  @unique // Folio fiscal
  serie           String?
  folio           String?
  fechaTimbrado   DateTime? @map("fecha_timbrado")
  noCertificadoSat String?  @map("no_certificado_sat")
  noCertificadoEmisor String? @map("no_certificado_emisor")

  // XML y PDF
  xmlOriginal     String?  @map("xml_original") @db.Text
  xmlTimbrado     String?  @map("xml_timbrado") @db.Text
  cadenaOriginal  String?  @map("cadena_original") @db.Text
  selloDigitalSat String?  @map("sello_digital_sat") @db.Text
  selloDigitalEmisor String? @map("sello_digital_emisor") @db.Text
  pdfPath         String?  @map("pdf_path")

  // Estado
  status          CfdiStatus @default(PENDING)
  cancelledAt     DateTime?  @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason")

  // PAC
  pacResponse     Json?    @map("pac_response")

  // Idempotencia y lock
  stampLockId     String?  @map("stamp_lock_id")
  stampLockAt     DateTime? @map("stamp_lock_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relaciones
  stampingAttempts StampingAttempt[]
  documents        ReceiptDocument[]

  @@map("cfdi_nominas")
}

// ============================================
// MÓDULO: PRESTACIONES Y BENEFICIOS
// ============================================

model Benefit {
  id              String   @id @default(uuid())
  name            String
  description     String?
  type            BenefitType
  value           Decimal? @db.Decimal(12, 2)
  valueType       BenefitValueType @map("value_type")
  isActive        Boolean  @default(true) @map("is_active")

  // Approval workflow
  status          BenefitStatus @default(PENDING)
  createdById     String?  @map("created_by_id")
  createdBy       User?    @relation("BenefitCreator", fields: [createdById], references: [id])
  approvedById    String?  @map("approved_by_id")
  approvedBy      User?    @relation("BenefitApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime? @map("approved_at")
  rejectedReason  String?  @map("rejected_reason")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  employeeBenefits EmployeeBenefit[]

  @@map("benefits")
}

enum BenefitStatus {
  PENDING
  APPROVED
  REJECTED
}

model EmployeeBenefit {
  id              String   @id @default(uuid())
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])
  benefitId       String   @map("benefit_id")
  benefit         Benefit  @relation(fields: [benefitId], references: [id])
  customValue     Decimal? @map("custom_value") @db.Decimal(12, 2)
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, benefitId])
  @@map("employee_benefits")
}

// ============================================
// MÓDULO: CATÁLOGOS
// ============================================

model Bank {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  employees Employee[]

  @@map("banks")
}

// ============================================
// ENUMS
// ============================================

// Tipo de institucion
enum InstitutionType {
  PRIVATE       // Empresa privada
  GOVERNMENT    // Institucion de gobierno
}

// Instituciones de gobierno mexicanas
enum GovInstitution {
  // Sector Salud
  IMSS          // Instituto Mexicano del Seguro Social
  ISSSTE        // Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado
  INSABI        // Instituto de Salud para el Bienestar (antes Seguro Popular)
  IMSS_BIENESTAR // IMSS-Bienestar

  // Fuerzas Armadas
  SEDENA        // Secretaria de la Defensa Nacional
  SEMAR         // Secretaria de Marina

  // Cultura y Educacion
  INAH          // Instituto Nacional de Antropologia e Historia
  INBA          // Instituto Nacional de Bellas Artes
  SEP           // Secretaria de Educacion Publica
  UNAM          // Universidad Nacional Autonoma de Mexico
  IPN           // Instituto Politecnico Nacional

  // Energia
  PEMEX         // Petroleos Mexicanos
  CFE           // Comision Federal de Electricidad

  // Otros
  SAT           // Servicio de Administracion Tributaria
  BANXICO       // Banco de Mexico
  CONAGUA       // Comision Nacional del Agua
  INEGI         // Instituto Nacional de Estadistica y Geografia
  OTHER         // Otra institucion de gobierno
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  COHABITING
}

enum ContractType {
  INDEFINITE        // Indefinido
  FIXED_TERM        // Por tiempo determinado
  SEASONAL          // Por temporada
  TRIAL_PERIOD      // Periodo de prueba
  TRAINING          // Capacitación inicial
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  HOURLY
}

enum SalaryType {
  MONTHLY
  BIWEEKLY
  WEEKLY
  DAILY
  HOURLY
}

enum PaymentMethod {
  TRANSFER
  CHECK
  CASH
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum TipoSalarioIMSS {
  FIJO
  VARIABLE
  MIXTO
}

enum RiskLevel {
  CLASE_I     // 0.54355%
  CLASE_II    // 1.13065%
  CLASE_III   // 2.59840%
  CLASE_IV    // 4.65325%
  CLASE_V     // 7.58875%
}

enum DocumentType {
  INE
  PASSPORT
  CURP
  RFC
  NSS
  PROOF_OF_ADDRESS
  BIRTH_CERTIFICATE
  DEGREE
  CONTRACT
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EARLY_LEAVE
  VACATION
  SICK_LEAVE
  PERMIT
  HOLIDAY
  REST_DAY
}

enum LeaveType {
  VACATION              // Vacaciones
  SICK_LEAVE            // Incapacidad por enfermedad
  SICK_LEAVE_IMSS       // Incapacidad IMSS (enfermedad general)
  WORK_ACCIDENT         // Accidente de trabajo
  MATERNITY             // Maternidad
  PATERNITY             // Paternidad
  BEREAVEMENT_DIRECT    // Duelo familiar directo (padres, hijos, conyuge)
  BEREAVEMENT_INDIRECT  // Duelo familiar indirecto (abuelos, hermanos)
  PERSONAL              // Personal con goce de sueldo
  UNPAID                // Sin goce de sueldo
  MEDICAL_APPOINTMENT   // Cita medica
  GOVERNMENT_PROCEDURE  // Tramite gubernamental
  STUDY_PERMIT          // Permiso de estudios
  OTHER                 // Otro
}

enum RequestStatus {
  PENDING               // Esperando aprobación del supervisor
  SUPERVISOR_APPROVED   // Supervisor aprobó, esperando validación de RH
  APPROVED              // Aprobado por RH (estado final)
  REJECTED              // Rechazado (por supervisor o RH)
  CANCELLED             // Cancelado por el empleado
}

enum PeriodType {
  WEEKLY
  BIWEEKLY
  MONTHLY
  EXTRAORDINARY  // Periodos extraordinarios
}

// Tipo de periodo extraordinario
enum ExtraordinaryType {
  AGUINALDO           // Aguinaldo / Christmas bonus
  VACATION_PREMIUM    // Prima vacacional
  PTU                 // Participacion de los trabajadores en las utilidades
  SETTLEMENT          // Finiquito
  LIQUIDATION         // Liquidacion
  BONUS               // Bono extraordinario
  RETROACTIVE         // Pago retroactivo
  OTHER               // Otro
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  CALCULATED
  APPROVED
  PAID
  CLOSED
  CANCELLED
}

enum PayrollDetailStatus {
  PENDING
  CALCULATED
  APPROVED
  PAID
  CANCELLED
}

enum ConceptType {
  PERCEPTION
  DEDUCTION
}

enum SalaryBaseType {
  SBC       // Salario Base de Cotización
  SMG       // Salario Mínimo General
  UMA       // Unidad de Medida y Actualización
  FIXED     // Monto fijo
}

enum InfonavitDiscountType {
  PERCENTAGE          // Porcentaje del salario
  FIXED_AMOUNT        // Cuota fija mensual
  VSM                 // Veces Salario Mínimo
}

enum PensionDiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum CfdiStatus {
  PENDING
  STAMPED
  CANCELLED
  ERROR
}

enum BenefitType {
  // Prestaciones comunes (privadas y gobierno)
  FOOD_VOUCHERS       // Vales de despensa
  SAVINGS_FUND        // Fondo de ahorro
  BONUS               // Bonos
  LIFE_INSURANCE      // Seguro de vida
  MAJOR_MEDICAL       // Gastos médicos mayores
  PRODUCTIVITY_BONUS  // Bono de productividad
  ATTENDANCE_BONUS    // Bono de asistencia
  PUNCTUALITY_BONUS   // Bono de puntualidad
  TRANSPORTATION      // Ayuda de transporte

  // Prestaciones de gobierno
  QUINQUENIO          // Quinquenio (5 años de servicio)
  ESTIMULO_ANTIGUEDAD // Estimulo por antiguedad
  AYUDA_LENTES        // Ayuda para lentes
  AYUDA_DEFUNCION     // Ayuda por defuncion
  CANASTA_BASICA      // Canasta basica
  AYUDA_GUARDERIA     // Ayuda para guarderia
  AYUDA_ESCOLAR       // Ayuda escolar / Utiles escolares
  BONO_DIA_MADRE      // Bono dia de las madres
  BONO_DIA_PADRE      // Bono dia del padre
  BONO_NAVIDAD        // Bono navideño
  BONO_REYES          // Bono dia de reyes
  BONO_ANIVERSARIO    // Bono de aniversario institucional
  PRIMA_DOMINICAL     // Prima dominical
  COMPENSACION_RIESGO // Compensacion por riesgo (SEDENA, SEMAR, etc.)
  SERVICIO_MEDICO     // Servicio medico adicional
  PENSION_COMPLEMENTARIA // Pension complementaria
  SEGURO_RETIRO       // Seguro de retiro adicional
  SEGURO_SEPARACION   // Seguro de separacion individualizado
  PRESTAMO_PERSONAL   // Prestamo personal
  PRESTAMO_HIPOTECARIO // Prestamo hipotecario (FOVISSSTE, ISSFAM)
  VALES_ROPA          // Vales de ropa
  CREDENCIAL_ISSSTE   // Credencial ISSSTE/IMSS
  SUBSIDIO_COMEDOR    // Subsidio de comedor
  TURNO_EXTRA         // Pago de turno extra

  OTHER
}

enum BenefitValueType {
  FIXED_AMOUNT
  PERCENTAGE_SALARY
  DAYS_SALARY
}

// Enums para Incidencias
enum IncidentCategory {
  ABSENCE           // Faltas
  TARDINESS         // Retardos
  EARLY_LEAVE       // Salidas anticipadas
  OVERTIME          // Horas extra
  BONUS             // Bonos
  DEDUCTION         // Descuentos (valor original de la migracion)
  DISABILITY        // Incapacidad
  JUSTIFIED_ABSENCE // Falta justificada
  OTHER             // Otros
}

enum IncidentValueType {
  DAYS              // Dias
  HOURS             // Horas
  AMOUNT            // Monto fijo (valor original de la migracion)
  PERCENTAGE        // Porcentaje
}

enum IncidentStatus {
  PENDING           // Pendiente de revision
  APPROVED          // Aprobada
  REJECTED          // Rechazada
  APPLIED           // Aplicada a nomina
  CANCELLED         // Cancelada
}

// ============================================
// MÓDULO: CONFIGURACIÓN CONTABLE Y FISCAL
// ============================================

// Configuración de ISN (Impuesto Sobre Nómina) por Estado
model StateIsnConfig {
  id          String   @id @default(uuid())
  stateCode   String   @unique @map("state_code") // Código del estado (AGS, BC, etc.)
  stateName   String   @map("state_name")
  rate        Decimal  @db.Decimal(5, 4) // Tasa del ISN (ej: 0.0300 = 3%)
  threshold   Decimal? @db.Decimal(14, 2) // Umbral mínimo para aplicar ISN
  exemptions  Json?    // Exenciones específicas del estado
  notes       String?
  effectiveFrom DateTime @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("state_isn_configs")
}

// Valores de UMA y SMG por año
model FiscalValues {
  id          String   @id @default(uuid())
  year        Int      @unique
  umaDaily    Decimal  @map("uma_daily") @db.Decimal(10, 4) // UMA diaria
  umaMonthly  Decimal  @map("uma_monthly") @db.Decimal(12, 4) // UMA mensual
  umaYearly   Decimal  @map("uma_yearly") @db.Decimal(14, 4) // UMA anual
  smgDaily    Decimal  @map("smg_daily") @db.Decimal(10, 4) // Salario Mínimo General diario
  smgZfnDaily Decimal? @map("smg_zfn_daily") @db.Decimal(10, 4) // SMG Zona Frontera Norte
  aguinaldoDays Int    @default(15) @map("aguinaldo_days") // Días de aguinaldo (15 o 30)
  vacationPremiumPercent Decimal @default(0.25) @map("vacation_premium_percent") @db.Decimal(5, 4) // Prima vacacional (25%)
  ptuDeadline DateTime? @map("ptu_deadline") @db.Date // Fecha límite PTU
  isrTableVersion String? @map("isr_table_version") // Versión de tabla ISR
  effectiveFrom DateTime @map("effective_from") @db.Date
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("fiscal_values")
}

// Tasas de riesgo de trabajo IMSS
model WorkRiskRate {
  id        String   @id @default(uuid())
  year      Int
  riskClass String   @map("risk_class") // CLASE_I, CLASE_II, etc.
  rate      Decimal  @db.Decimal(10, 7) // Tasa de prima (ej: 0.0054355)
  minRate   Decimal? @map("min_rate") @db.Decimal(10, 7) // Tasa mínima
  maxRate   Decimal? @map("max_rate") @db.Decimal(10, 7) // Tasa máxima
  description String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([year, riskClass])
  @@map("work_risk_rates")
}

// Configuración de mapeo de conceptos de incidencias
model IncidentConceptMapping {
  id              String   @id @default(uuid())
  companyId       String?  @map("company_id") // null = default global
  company         Company? @relation(fields: [companyId], references: [id])
  incidentTypeId  String   @map("incident_type_id")
  incidentType    IncidentType @relation(fields: [incidentTypeId], references: [id])
  conceptId       String   @map("concept_id")
  concept         PayrollConcept @relation(fields: [conceptId], references: [id])
  isRetroactive   Boolean  @default(false) @map("is_retroactive")
  priority        Int      @default(0) // Para ordenar cuando hay múltiples mappings
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([companyId, incidentTypeId, isRetroactive])
  @@map("incident_concept_mappings")
}

// Configuración de nómina por empresa
model CompanyPayrollConfig {
  id                String   @id @default(uuid())
  companyId         String   @unique @map("company_id")
  company           Company  @relation(fields: [companyId], references: [id])

  // Configuración de períodos
  defaultPeriodType PeriodType @default(BIWEEKLY) @map("default_period_type")
  payDayOfWeek      Int?     @map("pay_day_of_week") // Día de pago (1-7)
  payDayOfMonth     Int?     @map("pay_day_of_month") // Día del mes para pago

  // ISN
  stateCode         String?  @map("state_code") // Estado para cálculo de ISN
  applyIsn          Boolean  @default(true) @map("apply_isn")

  // Aguinaldo
  aguinaldoDays     Int      @default(15) @map("aguinaldo_days") // Días de aguinaldo
  aguinaldoPayMonth Int      @default(12) @map("aguinaldo_pay_month") // Mes de pago
  aguinaldoPayDay   Int      @default(20) @map("aguinaldo_pay_day") // Día de pago

  // Prima vacacional
  vacationPremiumPercent Decimal @default(0.25) @map("vacation_premium_percent") @db.Decimal(5, 4)

  // PTU
  applyPtu          Boolean  @default(true) @map("apply_ptu")
  ptuPercent        Decimal  @default(0.10) @map("ptu_percent") @db.Decimal(5, 4) // 10%
  ptuPayMonth       Int      @default(5) @map("ptu_pay_month") // Mayo
  ptuPayDay         Int      @default(30) @map("ptu_pay_day")

  // Fondo de ahorro
  savingsFundEnabled Boolean @default(false) @map("savings_fund_enabled")
  savingsFundEmployeePercent Decimal? @map("savings_fund_employee_percent") @db.Decimal(5, 4)
  savingsFundCompanyPercent Decimal? @map("savings_fund_company_percent") @db.Decimal(5, 4)
  savingsFundMaxPercent Decimal? @default(0.13) @map("savings_fund_max_percent") @db.Decimal(5, 4)

  // Caja de ahorro
  savingsBoxEnabled Boolean @default(false) @map("savings_box_enabled")
  savingsBoxEmployeePercent Decimal? @map("savings_box_employee_percent") @db.Decimal(5, 4)

  // Vales de despensa
  foodVouchersEnabled Boolean @default(false) @map("food_vouchers_enabled")
  foodVouchersPercent Decimal? @map("food_vouchers_percent") @db.Decimal(5, 4)
  foodVouchersMaxUma  Decimal? @map("food_vouchers_max_uma") @db.Decimal(5, 2) // Máx en UMAs (exento)

  // Horas extra
  overtimeDoubleAfter Int @default(9) @map("overtime_double_after") // Después de X horas = doble
  overtimeTripleAfter Int @default(3) @map("overtime_triple_after") // Después de X horas extra = triple
  maxOvertimeHoursWeek Int @default(9) @map("max_overtime_hours_week") // Máx horas extra semana

  // Otros
  applySubsidioEmpleo Boolean @default(true) @map("apply_subsidio_empleo")
  roundingMethod    String   @default("ROUND") @map("rounding_method") // ROUND, FLOOR, CEIL

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("company_payroll_configs")
}

// Conceptos de nómina por empresa (personalización)
model CompanyPayrollConcept {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  company         Company  @relation(fields: [companyId], references: [id])
  conceptId       String   @map("concept_id")
  concept         PayrollConcept @relation(fields: [conceptId], references: [id])

  // Configuración específica de la empresa
  customName      String?  @map("custom_name") // Nombre personalizado
  customCode      String?  @map("custom_code") // Código personalizado
  defaultAmount   Decimal? @map("default_amount") @db.Decimal(12, 2)
  formula         String?  // Fórmula de cálculo personalizada
  appliesTo       String?  @map("applies_to") // "ALL", "DEPARTMENT:xxx", "POSITION:xxx"
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([companyId, conceptId])
  @@map("company_payroll_concepts")
}

// Cálculo de liquidaciones/finiquitos
model LiquidationCalculation {
  id              String   @id @default(uuid())
  employeeId      String   @map("employee_id")
  employee        Employee @relation(fields: [employeeId], references: [id])

  // Tipo
  type            LiquidationType
  terminationDate DateTime @map("termination_date") @db.Date
  terminationReason String? @map("termination_reason")

  // Datos del empleado al momento
  dailySalary     Decimal  @map("daily_salary") @db.Decimal(12, 4)
  integratedSalary Decimal @map("integrated_salary") @db.Decimal(12, 4)
  yearsOfService  Decimal  @map("years_of_service") @db.Decimal(5, 2)

  // Conceptos calculados
  pendingSalary   Decimal  @default(0) @map("pending_salary") @db.Decimal(14, 2) // Salario pendiente
  proportionalAguinaldo Decimal @default(0) @map("proportional_aguinaldo") @db.Decimal(14, 2)
  proportionalVacation Decimal @default(0) @map("proportional_vacation") @db.Decimal(14, 2)
  vacationPremium Decimal  @default(0) @map("vacation_premium") @db.Decimal(14, 2)

  // Solo para liquidación (despido injustificado)
  indemnization90Days Decimal @default(0) @map("indemnization_90_days") @db.Decimal(14, 2) // 90 días
  indemnization20Days Decimal @default(0) @map("indemnization_20_days") @db.Decimal(14, 2) // 20 días por año
  seniorityPremium Decimal @default(0) @map("seniority_premium") @db.Decimal(14, 2) // Prima de antigüedad

  // Deducciones
  pendingLoans    Decimal  @default(0) @map("pending_loans") @db.Decimal(14, 2)
  pendingInfonavit Decimal @default(0) @map("pending_infonavit") @db.Decimal(14, 2)
  otherDeductions Decimal  @default(0) @map("other_deductions") @db.Decimal(14, 2)
  isrRetention    Decimal  @default(0) @map("isr_retention") @db.Decimal(14, 2)

  // Totales
  grossTotal      Decimal  @map("gross_total") @db.Decimal(14, 2)
  totalDeductions Decimal  @map("total_deductions") @db.Decimal(14, 2)
  netTotal        Decimal  @map("net_total") @db.Decimal(14, 2)

  // Estado
  status          LiquidationStatus @default(DRAFT)
  calculatedAt    DateTime @default(now()) @map("calculated_at")
  approvedAt      DateTime? @map("approved_at")
  approvedById    String?  @map("approved_by_id")
  paidAt          DateTime? @map("paid_at")

  // Detalles JSON
  calculationDetails Json? @map("calculation_details")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("liquidation_calculations")
}

enum LiquidationType {
  FINIQUITO     // Renuncia voluntaria
  LIQUIDACION   // Despido injustificado
  RESCISION     // Rescisión de contrato
  JUBILACION    // Jubilación
  MUERTE        // Fallecimiento del trabajador
}

enum LiquidationStatus {
  DRAFT
  CALCULATED
  APPROVED
  PAID
  CANCELLED
}

// Tabla ISR (tarifas mensuales)
model IsrTable {
  id              String   @id @default(uuid())
  year            Int
  periodType      PeriodType @map("period_type") // WEEKLY, BIWEEKLY, MONTHLY
  lowerLimit      Decimal  @map("lower_limit") @db.Decimal(14, 2)
  upperLimit      Decimal  @map("upper_limit") @db.Decimal(14, 2)
  fixedFee        Decimal  @map("fixed_fee") @db.Decimal(14, 2)
  rateOnExcess    Decimal  @map("rate_on_excess") @db.Decimal(5, 4) // Porcentaje sobre excedente
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([year, periodType, lowerLimit])
  @@map("isr_tables")
}

// Tabla de Subsidio al Empleo
model SubsidioEmpleoTable {
  id              String   @id @default(uuid())
  year            Int
  periodType      PeriodType @map("period_type")
  lowerLimit      Decimal  @map("lower_limit") @db.Decimal(14, 2)
  upperLimit      Decimal  @map("upper_limit") @db.Decimal(14, 2)
  subsidyAmount   Decimal  @map("subsidy_amount") @db.Decimal(14, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([year, periodType, lowerLimit])
  @@map("subsidio_empleo_tables")
}

// ============================================
// MÓDULO: AUDITORÍA DE CÁLCULOS DE NÓMINA
// ============================================

// Auditoría de cálculos de nómina - Transparencia en cálculos
model PayrollCalculationAudit {
  id              String   @id @default(uuid())
  payrollDetailId String   @map("payroll_detail_id")
  payrollDetail   PayrollDetail @relation(fields: [payrollDetailId], references: [id], onDelete: Cascade)

  calculatedAt    DateTime @map("calculated_at")
  calculatedBy    String?  @map("calculated_by")

  // Desglose de percepciones (JSON con pasos de cálculo)
  perceptionBreakdown Json @map("perception_breakdown")

  // Desglose de deducciones (JSON con pasos de cálculo)
  deductionBreakdown  Json @map("deduction_breakdown")

  // Snapshot de configuración usada
  configSnapshot  Json     @map("config_snapshot")

  // Metadatos
  version         Int      @default(1)
  isLatest        Boolean  @default(true) @map("is_latest")

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("payroll_calculation_audits")
}

// Auditoría de recálculos
model RecalculationAudit {
  id              String   @id @default(uuid())

  type            String   // 'SINGLE' o 'PERIOD'
  payrollPeriodId String?  @map("payroll_period_id")
  payrollDetailId String?  @map("payroll_detail_id")

  reason          String   @db.Text
  recalculatedBy  String   @map("recalculated_by")
  recalculatedAt  DateTime @default(now()) @map("recalculated_at")

  // Estado anterior al recálculo
  previousState   Json     @map("previous_state")

  // Nuevo estado después del recálculo
  newState        Json     @map("new_state")

  // Resumen de diferencias
  differences     Json

  // Control de reversión
  revertedAt      DateTime? @map("reverted_at")
  revertedBy      String?   @map("reverted_by")

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("recalculation_audits")
}

// ============================================
// MÓDULO: NÓMINAS ESPECIALES (Aguinaldo, PTU, Bonos)
// ============================================

// Configuración de nóminas especiales por empresa
model CompanySpecialPayrollConfig {
  id              String   @id @default(uuid())
  companyId       String   @unique @map("company_id")
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Configuración de Aguinaldo
  aguinaldoDays               Int      @default(15) @map("aguinaldo_days")
  aguinaldoDefaultPaymentMonth Int     @default(12) @map("aguinaldo_default_payment_month")
  aguinaldoDefaultPaymentDay   Int     @default(20) @map("aguinaldo_default_payment_day")
  aguinaldoIncludeVariableIncome Boolean @default(false) @map("aguinaldo_include_variable")

  // Configuración de PTU
  ptuEnabled                  Boolean  @default(true) @map("ptu_enabled")
  ptuDefaultPaymentMonth      Int      @default(5) @map("ptu_default_payment_month")
  ptuMaxSalaryMultiplier      Decimal? @map("ptu_max_salary_multiplier") @db.Decimal(5, 2)

  // Plantillas de bonos (JSON con configuraciones predefinidas)
  bonusTemplates              Json?    @map("bonus_templates")

  // Configuración de finiquito/liquidación
  liquidationSeniorityPremium Decimal  @default(12) @map("liquidation_seniority_premium") @db.Decimal(5, 2) // Días por año
  liquidation3MonthsConstitutional Boolean @default(true) @map("liquidation_3months_constitutional")
  liquidation20DaysPerYear    Boolean  @default(true) @map("liquidation_20days_per_year")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("company_special_payroll_configs")
}

// Historial de nóminas especiales
model SpecialPayrollHistory {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type            ExtraordinaryType
  year            Int
  periodId        String?  @map("period_id")

  totalEmployees  Int      @map("total_employees")
  totalGross      Decimal  @map("total_gross") @db.Decimal(14, 2)
  totalExempt     Decimal  @default(0) @map("total_exempt") @db.Decimal(14, 2)
  totalTaxable    Decimal  @default(0) @map("total_taxable") @db.Decimal(14, 2)
  totalIsr        Decimal  @default(0) @map("total_isr") @db.Decimal(14, 2)
  totalNet        Decimal  @map("total_net") @db.Decimal(14, 2)

  // Datos específicos según el tipo
  configSnapshot  Json     @map("config_snapshot")
  calculationSummary Json  @map("calculation_summary")
  employeeDetails Json?    @map("employee_details") // Detalle por empleado

  status          String   @default("DRAFT") // DRAFT, CALCULATED, APPROVED, PAID
  paymentDate     DateTime? @map("payment_date")

  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       String?  @map("created_by")
  approvedAt      DateTime? @map("approved_at")
  approvedBy      String?  @map("approved_by")

  @@map("special_payroll_history")
}

// ============================================
// MÓDULO: CONFIGURACIÓN DE CÁLCULOS POR EMPRESA
// ============================================

// Fórmulas personalizadas de cálculo por empresa
// Mejora: Versionado por ejercicio fiscal
model CompanyCalculationFormula {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  conceptCode     String   @map("concept_code") // P001, D001, etc.
  conceptType     String   @map("concept_type") // PERCEPTION, DEDUCTION

  name            String
  description     String?  @db.Text

  // Fórmula de cálculo (expresión evaluable)
  formula         String   @db.Text // Ej: "baseSalary * workedDays / 30"

  // Variables disponibles para la fórmula
  availableVariables Json  @default("[]") @map("available_variables")

  // MEJORA: Versionado por ejercicio fiscal
  fiscalYear      Int?     @map("fiscal_year") // Año fiscal de aplicación
  validFrom       DateTime? @map("valid_from") @db.Date // Inicio de vigencia
  validTo         DateTime? @map("valid_to") @db.Date // Fin de vigencia (null = indefinido)
  version         Int      @default(1) // Versión de la fórmula

  // Configuración fiscal
  isTaxable       Boolean  @default(true) @map("is_taxable")
  isExempt        Boolean  @default(false) @map("is_exempt")
  exemptLimit     Decimal? @map("exempt_limit") @db.Decimal(14, 2) // En UMAs o monto fijo
  exemptLimitType String?  @map("exempt_limit_type") // UMA, SMG, FIXED

  // SAT Integration
  satConceptKey   String?  @map("sat_concept_key")

  isActive        Boolean  @default(true) @map("is_active")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relaciones de uso
  perceptions     PayrollPerception[]
  deductions      PayrollDeduction[]

  @@unique([companyId, conceptCode])
  @@index([companyId, fiscalYear, isActive], name: "idx_formulas_fiscal_year_active")
  @@map("company_calculation_formulas")
}

// Auditoría de cálculos fiscales por concepto
// Cumple: Registrar cada cálculo fiscal con base y regla aplicada
// MEJORA GOB: Incluye referencia legal obligatoria
model FiscalCalculationAudit {
  id                String   @id @default(uuid())
  payrollDetailId   String   @map("payroll_detail_id")
  payrollDetail     PayrollDetail @relation(fields: [payrollDetailId], references: [id], onDelete: Restrict)

  conceptType       String   @map("concept_type") // ISR, IMSS_EMPLOYEE, IMSS_EMPLOYER, SUBSIDIO
  conceptCode       String   @map("concept_code")

  // Valores de entrada
  inputValues       Json     @map("input_values")

  // Regla/tabla aplicada
  ruleApplied       String?  @map("rule_applied")
  ruleVersion       String?  @map("rule_version")
  tableUsed         String?  @map("table_used")

  // Base de cálculo desglosada
  calculationBase   Decimal  @map("calculation_base") @db.Decimal(14, 2)
  limitInferior     Decimal? @map("limit_inferior") @db.Decimal(14, 2)
  excedente         Decimal? @db.Decimal(14, 2)
  impuestoMarginal  Decimal? @map("impuesto_marginal") @db.Decimal(14, 2)
  cuotaFija         Decimal? @map("cuota_fija") @db.Decimal(14, 2)
  resultAmount      Decimal  @map("result_amount") @db.Decimal(14, 2)

  // MEJORA GOB: Referencia legal obligatoria
  legalReference    Json?    @map("legal_reference") // {law, article, source, publishedAt, notes}
  legalLaw          String?  @map("legal_law") // Ley aplicada (LISR, LIMSS, etc.)
  legalArticle      String?  @map("legal_article") // Artículo específico
  legalSource       String?  @map("legal_source") // Fuente (DOF, etc.)
  legalPublishedAt  DateTime? @map("legal_published_at") @db.Date

  // Metadata
  fiscalYear        Int      @map("fiscal_year")
  periodType        String   @map("period_type")
  calculatedAt      DateTime @default(now()) @map("calculated_at")
  calculatedBy      String?  @map("calculated_by")

  @@index([payrollDetailId])
  @@index([conceptType, conceptCode])
  @@index([fiscalYear])
  @@map("fiscal_calculation_audit")
}

// ============================================
// MÓDULO: SEGURIDAD Y AUDITORÍA AVANZADA
// ============================================

// Registro de accesos a secretos cifrados
model SecretAccessLog {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  companyId   String   @map("company_id")
  secretType  String   @map("secret_type") // CERTIFICATE, PAC_CREDENTIALS
  purpose     String   // STAMP_CFDI, CANCEL_CFDI, MIGRATION
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId, companyId])
  @@index([createdAt])
  @@index([secretType])
  @@map("secret_access_logs")
}

// Versiones históricas de detalles de nómina
// Cumple con: Sección 4 - Versionar recibos: ningún recálculo debe sobrescribir información previa
model PayrollDetailVersion {
  id              String   @id @default(uuid())
  payrollDetailId String   @map("payroll_detail_id")
  payrollDetail   PayrollDetail @relation(fields: [payrollDetailId], references: [id], onDelete: Restrict)
  version         Int      @default(1)

  // Snapshot de datos al momento del versionado
  workedDays        Decimal  @map("worked_days") @db.Decimal(5, 2)
  totalPerceptions  Decimal  @map("total_perceptions") @db.Decimal(12, 2)
  totalDeductions   Decimal  @map("total_deductions") @db.Decimal(12, 2)
  netPay            Decimal  @map("net_pay") @db.Decimal(12, 2)
  status            String

  // Detalle completo en JSON
  perceptionsSnapshot Json   @map("perceptions_snapshot")
  deductionsSnapshot  Json   @map("deductions_snapshot")
  calculationConfig   Json?  @map("calculation_config")

  // Metadata
  createdBy     String?  @map("created_by")
  createdReason String?  @map("created_reason") @db.Text // INITIAL, RECALCULATION, CORRECTION
  createdAt     DateTime @default(now()) @map("created_at")

  // Referencia al CFDI si existe
  cfdiUuid    String?  @map("cfdi_uuid")
  cfdiStatus  String?  @map("cfdi_status")

  @@unique([payrollDetailId, version])
  @@index([payrollDetailId])
  @@map("payroll_detail_versions")
}

// ============================================
// MÓDULO: SNAPSHOT DE REGLAS POR RECIBO
// ============================================

// Snapshot de todas las reglas y valores fiscales usados en un cálculo
// Garantiza reproducibilidad aunque cambien reglas futuras
// MEJORA GOB: Incluye hash SHA256 para verificación de integridad
model ReceiptRulesetSnapshot {
  id                String   @id @default(uuid())
  payrollDetailId   String   @map("payroll_detail_id")
  payrollDetail     PayrollDetail @relation(fields: [payrollDetailId], references: [id], onDelete: Restrict)
  version           Int      @default(1)

  // Fórmulas usadas en el cálculo
  formulasUsed      Json     @default("[]") @map("formulas_used")

  // Valores fiscales vigentes al momento del cálculo
  umaDaily          Decimal  @map("uma_daily") @db.Decimal(14, 4)
  umaMonthly        Decimal  @map("uma_monthly") @db.Decimal(14, 4)
  smgDaily          Decimal  @map("smg_daily") @db.Decimal(14, 4)
  smgZfnDaily       Decimal? @map("smg_zfn_daily") @db.Decimal(14, 4)

  // Configuración de cálculo
  roundingMode      String   @default("HALF_UP") @map("rounding_mode")
  decimalScale      Int      @default(2) @map("decimal_scale")

  // Tablas fiscales usadas
  isrTableVersion     String?  @map("isr_table_version")
  subsidioTableVersion String? @map("subsidio_table_version")
  imssRatesVersion    String?  @map("imss_rates_version")

  // Parámetros adicionales
  fiscalYear        Int      @map("fiscal_year")
  periodType        String   @map("period_type")
  calculationParams Json     @default("{}") @map("calculation_params")

  // MEJORA GOB: Hash SHA256 para verificación de integridad
  snapshotHash      String?  @map("snapshot_hash") @db.VarChar(64)
  integrityStatus   String   @default("PENDING") @map("integrity_status") // PENDING, VERIFIED, CORRUPTED
  hashVerifiedAt    DateTime? @map("hash_verified_at")
  hashVerifiedBy    String?  @map("hash_verified_by")

  // Metadata
  createdAt         DateTime @default(now()) @map("created_at")
  createdBy         String?  @map("created_by")

  @@unique([payrollDetailId, version])
  @@index([payrollDetailId])
  @@index([snapshotHash], map: "idx_snapshot_hash")
  @@index([integrityStatus], map: "idx_snapshot_integrity")
  @@map("receipt_ruleset_snapshot")
}

// ============================================
// MÓDULO: AUTORIZACIÓN DE TIMBRADO
// ============================================

// Registro de autorizaciones de timbrado por período
model StampingAuthorization {
  id              String    @id @default(uuid())
  periodId        String    @map("period_id")
  period          PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)

  authorizedBy    String    @map("authorized_by")
  authorizedAt    DateTime  @default(now()) @map("authorized_at")

  revokedAt       DateTime? @map("revoked_at")
  revokedBy       String?   @map("revoked_by")
  revokeReason    String?   @map("revoke_reason")

  isActive        Boolean   @default(true) @map("is_active")
  details         Json?

  @@index([periodId, isActive])
  @@map("stamping_authorization")
}

// ============================================
// MÓDULO: IDEMPOTENCIA DE TIMBRADO
// ============================================

// Registro de intentos de timbrado para garantizar idempotencia
model StampingAttempt {
  id              String    @id @default(uuid())
  cfdiId          String    @map("cfdi_id")
  cfdi            CfdiNomina @relation(fields: [cfdiId], references: [id], onDelete: Restrict)
  receiptVersion  Int       @map("receipt_version")
  idempotencyKey  String    @unique @map("idempotency_key")

  status          String    @default("PENDING") // PENDING, IN_PROGRESS, SUCCESS, FAILED
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  workerId        String?   @map("worker_id")
  errorMessage    String?   @map("error_message")
  errorType       String?   @map("error_type")
  pacResponse     Json?     @map("pac_response")

  @@index([cfdiId, status])
  @@map("stamping_attempt")
}

// ============================================
// MÓDULO: EVIDENCIAS FISCALES
// ============================================

// Documentos asociados a recibos de nómina (XML, PDF, acuses)
model ReceiptDocument {
  id                String    @id @default(uuid())
  payrollDetailId   String    @map("payroll_detail_id")
  payrollDetail     PayrollDetail @relation(fields: [payrollDetailId], references: [id], onDelete: Restrict)
  cfdiId            String?   @map("cfdi_id")
  cfdi              CfdiNomina? @relation(fields: [cfdiId], references: [id], onDelete: SetNull)

  type              String    // XML_ORIGINAL, XML_TIMBRADO, PDF, CANCEL_ACK, CANCEL_REQUEST
  storagePath       String    @unique @map("storage_path")
  fileName          String    @map("file_name")
  mimeType          String    @map("mime_type")
  fileSize          Int       @map("file_size")
  sha256            String

  version           Int       @default(1)
  isActive          Boolean   @default(true) @map("is_active")

  createdAt         DateTime  @default(now()) @map("created_at")
  createdBy         String?   @map("created_by")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  deleteReason      String?   @map("delete_reason")

  @@index([payrollDetailId, type, isActive])
  @@index([cfdiId])
  @@map("receipt_document")
}

// ============================================
// MÓDULO: CATÁLOGO DE PACs AUTORIZADOS
// ============================================

// Catálogo de Proveedores Autorizados de Certificación (PAC)
// Lista oficial del SAT: https://www.sat.gob.mx/consultas/20585/conoce-los-servicios-gratuitos-de-factura-electronica-
model PacProvider {
  id              String   @id @default(uuid())

  // Identificación
  code            String   @unique // Código interno único (FINKOK, DIGIBOX, SW_SAPIEN, etc.)
  name            String   // Nombre comercial
  legalName       String   @map("legal_name") // Razón social oficial

  // URLs de servicios
  sandboxStampUrl    String?  @map("sandbox_stamp_url") @db.Text
  sandboxCancelUrl   String?  @map("sandbox_cancel_url") @db.Text
  productionStampUrl String?  @map("production_stamp_url") @db.Text
  productionCancelUrl String? @map("production_cancel_url") @db.Text

  // Tipo de integración
  integrationType    String   @default("SOAP") @map("integration_type") // SOAP, REST, CUSTOM
  documentationUrl   String?  @map("documentation_url") @db.Text

  // Campos requeridos para autenticación (JSON schema)
  // Ejemplo: ["user", "password"] o ["token"] o ["clientId", "clientSecret"]
  requiredFields     Json     @default("[\"user\", \"password\"]") @map("required_fields")

  // Soporte de servicios
  supportsStamping      Boolean @default(true) @map("supports_stamping")
  supportsCancellation  Boolean @default(true) @map("supports_cancellation")
  supportsQueryStatus   Boolean @default(false) @map("supports_query_status")
  supportsRecovery      Boolean @default(false) @map("supports_recovery")

  // Estado
  isOfficial         Boolean  @default(true) @map("is_official") // PAC oficial SAT vs custom
  isActive           Boolean  @default(true) @map("is_active")
  isImplemented      Boolean  @default(false) @map("is_implemented") // Si tiene implementación en código

  // Información adicional
  notes              String?  @db.Text
  logoUrl            String?  @map("logo_url")
  websiteUrl         String?  @map("website_url")
  supportEmail       String?  @map("support_email")
  supportPhone       String?  @map("support_phone")

  // Ordenamiento y presentación
  sortOrder          Int      @default(100) @map("sort_order")
  isFeatured         Boolean  @default(false) @map("is_featured") // PACs recomendados/destacados

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyConfigs     CompanyPacConfig[]

  @@map("pac_providers")
}

// Configuración de PAC por empresa
model CompanyPacConfig {
  id              String   @id @default(uuid())

  companyId       String   @map("company_id")
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  pacProviderId   String   @map("pac_provider_id")
  pacProvider     PacProvider @relation(fields: [pacProviderId], references: [id])

  // Credenciales (encriptadas)
  credentials     Json     @default("{}") // Almacena los campos según requiredFields del PAC

  // Modo de operación
  mode            String   @default("sandbox") // sandbox | production

  // Estado
  isActive        Boolean  @default(true) @map("is_active")
  isPrimary       Boolean  @default(false) @map("is_primary") // PAC principal de la empresa

  // Última verificación
  lastTestedAt    DateTime? @map("last_tested_at")
  testStatus      String?   @map("test_status") // SUCCESS, FAILED, PENDING
  testMessage     String?   @map("test_message") @db.Text

  // Metadata
  configuredBy    String?   @map("configured_by")
  notes           String?   @db.Text

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([companyId, pacProviderId])
  @@index([companyId])
  @@map("company_pac_configs")
}

// ============================================
// MÓDULO: ENDURECIMIENTOS GUBERNAMENTALES
// Cumplimiento de normativas de gobierno MX
// ============================================

// Reglas de transición de estado válidas
model StateTransitionRule {
  id                  String   @id @default(uuid())
  entityType          String   @map("entity_type") // PAYROLL_PERIOD, PAYROLL_DETAIL, CFDI_NOMINA
  fromState           String   @map("from_state")
  toState             String   @map("to_state")
  action              String
  allowedRoles        Json     @default("[]") @map("allowed_roles")
  requiresJustification Boolean @default(false) @map("requires_justification")
  requiresDualControl Boolean  @default(false) @map("requires_dual_control")
  isCritical          Boolean  @default(false) @map("is_critical")
  description         String?  @db.Text
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  transitionLogs      StateTransitionLog[]

  @@unique([entityType, fromState, toState, action])
  @@map("state_transition_rules")
}

// Log de transiciones de estado
model StateTransitionLog {
  id                String   @id @default(uuid())
  entityType        String   @map("entity_type")
  entityId          String   @map("entity_id")
  fromState         String   @map("from_state")
  toState           String   @map("to_state")
  action            String
  transitionRuleId  String?  @map("transition_rule_id")
  transitionRule    StateTransitionRule? @relation(fields: [transitionRuleId], references: [id])
  userId            String   @map("user_id")
  userEmail         String?  @map("user_email")
  userRole          String?  @map("user_role")
  justification     String?  @db.Text
  isValid           Boolean  @map("is_valid")
  rejectionReason   String?  @map("rejection_reason") @db.Text
  ipAddress         String?  @map("ip_address") @db.VarChar(45)
  userAgent         String?  @map("user_agent") @db.Text
  metadata          Json     @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([userId])
  @@index([isValid])
  @@index([createdAt])
  @@map("state_transition_log")
}

// Acciones críticas pendientes de confirmación (doble control)
model PendingCriticalAction {
  id              String    @id @default(uuid())
  actionType      String    @map("action_type")
  entityType      String    @map("entity_type")
  entityId        String    @map("entity_id")
  requestedBy     String    @map("requested_by")
  requestedAt     DateTime  @default(now()) @map("requested_at")
  justification   String    @db.Text
  actionData      Json      @map("action_data")
  status          String    @default("PENDING") // PENDING, CONFIRMED, REJECTED, EXPIRED
  confirmedBy     String?   @map("confirmed_by")
  confirmedAt     DateTime? @map("confirmed_at")
  rejectedBy      String?   @map("rejected_by")
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([status])
  @@index([entityType, entityId])
  @@map("pending_critical_actions")
}

// Políticas de retención de documentos
model RetentionPolicy {
  id              String   @id @default(uuid())
  documentType    String   @unique @map("document_type")
  retentionYears  Int      @map("retention_years")
  legalBasis      String?  @map("legal_basis") @db.Text
  description     String?  @db.Text
  canDelete       Boolean  @default(false) @map("can_delete")
  requiresApproval Boolean @default(true) @map("requires_approval")
  approvedRoles   Json     @default("[\"ADMIN\"]") @map("approved_roles")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("retention_policies")
}

// Solicitudes de eliminación con auditoría
model DeletionRequest {
  id                    String    @id @default(uuid())
  documentType          String    @map("document_type")
  entityType            String    @map("entity_type")
  entityId              String    @map("entity_id")
  requestedBy           String    @map("requested_by")
  requestedAt           DateTime  @default(now()) @map("requested_at")
  justification         String    @db.Text
  legalBasis            String?   @map("legal_basis") @db.Text
  status                String    @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")
  rejectedBy            String?   @map("rejected_by")
  rejectedAt            DateTime? @map("rejected_at")
  rejectionReason       String?   @map("rejection_reason") @db.Text
  deletedAt             DateTime? @map("deleted_at")
  retentionCheckPassed  Boolean   @default(false) @map("retention_check_passed")
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([status])
  @@map("deletion_requests")
}

// Alertas de integridad de datos
model IntegrityAlert {
  id              String    @id @default(uuid())
  alertType       String    @map("alert_type") // HASH_MISMATCH, MISSING_DATA, CORRUPTION
  severity        String    // CRITICAL, HIGH, MEDIUM, LOW
  entityType      String    @map("entity_type")
  entityId        String    @map("entity_id")
  description     String    @db.Text
  expectedValue   String?   @map("expected_value") @db.Text
  actualValue     String?   @map("actual_value") @db.Text
  detectedAt      DateTime  @default(now()) @map("detected_at")
  detectedBy      String?   @map("detected_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  acknowledgedBy  String?   @map("acknowledged_by")
  resolutionNotes String?   @map("resolution_notes") @db.Text
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at")

  @@index([severity, isResolved])
  @@index([entityType, entityId])
  @@map("integrity_alerts")
}

// ============================================
// MÓDULO: P0.1 - AUTENTICACIÓN MFA
// ============================================

// Configuración de MFA por usuario
model MfaConfig {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret      String    // Secreto TOTP cifrado (Base32)
  backupCodes String    @map("backup_codes") // Códigos de respaldo cifrados (JSON array)
  status      String    @default("PENDING") // PENDING, ACTIVE, DISABLED
  createdAt   DateTime  @default(now()) @map("created_at")
  verifiedAt  DateTime? @map("verified_at")
  disabledAt  DateTime? @map("disabled_at")

  @@index([status])
  @@map("mfa_config")
}

